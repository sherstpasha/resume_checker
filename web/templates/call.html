{% extends "base.html" %}
{% block content %}
<h2>–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º #{{ cid }}</h2>

<div class="call-wrap">
  <div class="call-stage">
    <img id="botBackdrop" src="/static/image_bot.png" alt="bot" class="call-bot-bg">
    <video id="remoteVideo" autoplay playsinline class="call-remote"></video>
    <video id="localVideo" autoplay playsinline muted class="call-local"></video>
    <img id="personPlaceholder" src="/static/image_person.png" alt="you" class="call-local placeholder" style="display:none;">
  </div>
  <div class="call-controls">
    <button class="btn" id="joinBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button class="btn" id="leaveBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button class="btn" id="micToggle" disabled>–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª</button>
    <button class="btn" id="videoToggle" disabled>–ö–∞–º–µ—Ä–∞: –≤—ã–∫–ª</button>
    <span id="status" class="muted"></span>
  </div>
  <div class="vu-wrap" id="vuWrap" style="display:none">
    <div class="vu-bar"><div class="vu-fill" id="vuFill" style="width:0%"></div></div>
  </div>
  <div id="chat" class="card" style="max-width:960px;">
    <div id="log" style="min-height:120px; max-height:220px; overflow:auto;"></div>
  </div>
  <div class="muted">–î–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é) –∫ –∫–∞–º–µ—Ä–µ.</div>
  <input type="hidden" id="cid" value="{{ cid }}">
</div>
<script>
  let pc;
  const status = (t) => document.getElementById('status').textContent = t;

  async function join() {
    try {
      const cid = document.getElementById('cid').value;
      // websocket for transcripts/replies
      const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + `/call/ws/${cid}`);
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          const log = document.getElementById('log');
          const div = document.createElement('div');
          div.className = msg.role === 'assistant' ? 'msg assistant' : (msg.role === 'user' ? 'msg user' : 'msg sys');
          div.textContent = (msg.role === 'assistant' ? 'ü§ñ ' : (msg.role === 'user' ? 'üë§ ' : '‚ÑπÔ∏è ')) + (msg.text || '');
          log.appendChild(div);
          log.scrollTop = log.scrollHeight;
        } catch {}
      };
      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

      // remote
      const remoteVideo = document.getElementById('remoteVideo');
      pc.ontrack = (ev) => {
        if (ev.streams && ev.streams[0]) remoteVideo.srcObject = ev.streams[0];
        else remoteVideo.srcObject = new MediaStream([ev.track]);
      };

      // local
      // Try to get user media; if camera is unavailable, fall back to audio only
      let stream;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
      } catch(e) {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      }
      const localVideo = document.getElementById('localVideo');
      const placeholder = document.getElementById('personPlaceholder');
      if (stream.getVideoTracks().length) {
        localVideo.srcObject = stream;
        localVideo.style.display = '';
        placeholder.style.display = 'none';
      } else {
        localVideo.style.display = 'none';
        placeholder.style.display = '';
      }
      stream.getTracks().forEach(t => pc.addTrack(t, stream));

      // mic toggle
      const micBtn = document.getElementById('micToggle');
      const audioTrack = stream.getAudioTracks()[0] || null;
      micBtn.disabled = !audioTrack;
      function updateMic() {
        if (!audioTrack) return;
        micBtn.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω: ' + (audioTrack.enabled ? '–≤–∫–ª' : '–≤—ã–∫–ª');
      }
      micBtn.onclick = () => { if (audioTrack) { audioTrack.enabled = !audioTrack.enabled; updateMic(); } };
      updateMic();

      // VU meter (Web Audio API)
      try {
        const audioTracks = stream.getAudioTracks();
        if (audioTracks && audioTracks.length) {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const src = ctx.createMediaStreamSource(stream);
          const analyser = ctx.createAnalyser();
          analyser.fftSize = 2048;
          const data = new Float32Array(analyser.fftSize);
          src.connect(analyser);
          const wrap = document.getElementById('vuWrap');
          const fill = document.getElementById('vuFill');
          wrap.style.display = '';
          let rafId;
          const render = () => {
            analyser.getFloatTimeDomainData(data);
            // RMS
            let sum = 0;
            for (let i = 0; i < data.length; i++) { const v = data[i]; sum += v*v; }
            const rms = Math.sqrt(sum / data.length);
            const pct = Math.min(100, Math.max(0, Math.round(rms * 300))); // ~0.33 -> 100%
            fill.style.width = pct + '%';
            if (pct > 12) { fill.classList.add('on'); } else { fill.classList.remove('on'); }
            rafId = requestAnimationFrame(render);
          };
          render();
          // stop meter on leave
          document.getElementById('leaveBtn').addEventListener('click', () => {
            try { cancelAnimationFrame(rafId); ctx.close(); } catch(_) {}
            wrap.style.display = 'none';
          }, { once: true });
        }
      } catch(e) {
        // ignore VU errors
      }

      // video toggle (show placeholder when off)
      const videoBtn = document.getElementById('videoToggle');
      const videoTrack = stream.getVideoTracks()[0] || null;
      videoBtn.disabled = !videoTrack;
      function updateVideo() {
        if (!videoTrack) return;
        videoBtn.textContent = '–ö–∞–º–µ—Ä–∞: ' + (videoTrack.enabled ? '–≤–∫–ª' : '–≤—ã–∫–ª');
        if (videoTrack.enabled) { localVideo.style.display = ''; placeholder.style.display = 'none'; }
        else { localVideo.style.display = 'none'; placeholder.style.display = ''; }
      }
      videoBtn.onclick = () => { if (videoTrack) { videoTrack.enabled = !videoTrack.enabled; updateVideo(); } };
      updateVideo();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const resp = await fetch(`/webrtc/offer/${cid}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type })
      });
      const data = await resp.json();
      await pc.setRemoteDescription(new RTCSessionDescription(data));

      document.getElementById('joinBtn').disabled = true;
      document.getElementById('leaveBtn').disabled = false;
      document.getElementById('micToggle').disabled = false;
      if (videoTrack) document.getElementById('videoToggle').disabled = false;
      status('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
    } catch (e) {
      status('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
    }
  }

  function leave() {
    try {
      const cid = document.getElementById('cid').value;
      // notify server to finish interview
      fetch(`/call/finish/${cid}`, { method: 'POST' }).catch(()=>{});
      if (pc) {
        pc.getSenders().forEach(s => s.track && s.track.stop());
        pc.close();
        pc = null;
      }
    } finally {
      document.getElementById('joinBtn').disabled = false;
      document.getElementById('leaveBtn').disabled = true;
      // disable toggles when not connected
      const micBtn = document.getElementById('micToggle');
      const videoBtn = document.getElementById('videoToggle');
      micBtn.disabled = true; micBtn.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª';
      if (videoBtn) { videoBtn.disabled = true; videoBtn.textContent = '–ö–∞–º–µ—Ä–∞: –≤—ã–∫–ª'; }
      status('–û—Ç–∫–ª—é—á–µ–Ω–æ');
    }
  }

  document.getElementById('joinBtn').onclick = join;
  document.getElementById('leaveBtn').onclick = leave;
</script>
{% endblock %}
