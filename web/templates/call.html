{% extends "base.html" %}
{% block content %}
<h2>–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º #{{ cid }}</h2>

<div class="call-wrap">
  <div class="call-stage">
    <div id="botIndicator" class="bot-indicator listening" title="–°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞"></div>
    <video id="remoteVideo" autoplay playsinline class="call-remote"></video>
    <video id="localVideo" autoplay playsinline muted class="call-local"></video>
    <img id="personPlaceholder" src="/static/image_person.png" alt="you" class="call-local placeholder" style="display:none;">
  </div>
  <div class="call-controls">
    <button class="btn" id="joinBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button class="btn" id="leaveBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button class="btn" id="micToggle" disabled>–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª</button>
    <button class="btn" id="videoToggle" disabled>–ö–∞–º–µ—Ä–∞: –≤—ã–∫–ª</button>
    <span id="status" class="muted"></span>
  </div>
  <div id="chat" class="card" style="max-width:960px;">
    <div id="log" style="min-height:120px; max-height:220px; overflow:auto;"></div>
  </div>
  <div class="muted">–î–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é) –∫ –∫–∞–º–µ—Ä–µ.</div>
  <input type="hidden" id="cid" value="{{ cid }}">
</div>
<script>
  let pc;
  let ws;
  let joining = false;
  const status = (t) => document.getElementById('status').textContent = t;

  async function join() {
    try {
      if (pc || joining) { return; }
      joining = true;
      document.getElementById('joinBtn').disabled = true;
      const cid = document.getElementById('cid').value;
      // websocket for transcripts/replies (ensure single instance)
      if (ws) { try { ws.close(); } catch(_) {} ws = null; }
      ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + `/call/ws/${cid}`);
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          const log = document.getElementById('log');
          const div = document.createElement('div');
          div.className = msg.role === 'assistant' ? 'msg assistant' : (msg.role === 'user' ? 'msg user' : 'msg sys');
          div.textContent = (msg.role === 'assistant' ? 'ü§ñ ' : (msg.role === 'user' ? 'üë§ ' : '‚ÑπÔ∏è ')) + (msg.text || '');
          log.appendChild(div);
          log.scrollTop = log.scrollHeight;
        } catch {}
      };
      // Intercept state messages to toggle bot indicator (circle)
      const _origOnMsg = ws.onmessage;
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg && msg.role === 'state' && msg.state) {
            const el = document.getElementById('botIndicator');
            const st = String(msg.state).toLowerCase();
            el.classList.remove('speaking','thinking','listening');
            if (st === 'speaking') el.classList.add('speaking');
            else if (st === 'thinking') el.classList.add('thinking');
            else el.classList.add('listening');
            return;
          }
        } catch {}
        if (typeof _origOnMsg === 'function') { _origOnMsg(ev); }
      };
      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

      // remote
      const remoteVideo = document.getElementById('remoteVideo');
      pc.ontrack = (ev) => {
        if (ev.streams && ev.streams[0]) remoteVideo.srcObject = ev.streams[0];
        else remoteVideo.srcObject = new MediaStream([ev.track]);
      };

      // local
      // Try to get user media; if camera is unavailable, fall back to audio only
      let stream;
      try {
        // Prefer raw mic without browser DSP for better ASR
        stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            channelCount: 1,
            sampleRate: 48000
          },
          video: true
        });
      } catch(e) {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            channelCount: 1,
            sampleRate: 48000
          },
          video: false
        });
      }
      const localVideo = document.getElementById('localVideo');
      const placeholder = document.getElementById('personPlaceholder');
      // ensure camera starts disabled if present
      try { const vt0 = stream.getVideoTracks()[0]; if (vt0) vt0.enabled = false; } catch(_) {}
      localVideo.srcObject = stream;
      const _vt = stream.getVideoTracks()[0] || null;
      if (_vt && _vt.enabled) { localVideo.style.display = ''; placeholder.style.display = 'none'; }
      else { localVideo.style.display = 'none'; placeholder.style.display = ''; }
      stream.getTracks().forEach(t => pc.addTrack(t, stream));

      // mic toggle
      const micBtn = document.getElementById('micToggle');
      const audioTrack = stream.getAudioTracks()[0] || null;
      micBtn.disabled = !audioTrack;
      function updateMic() {
        if (!audioTrack) return;
        micBtn.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω: ' + (audioTrack.enabled ? '–≤–∫–ª' : '–≤—ã–∫–ª');
      }
      micBtn.onclick = () => { if (audioTrack) { audioTrack.enabled = !audioTrack.enabled; updateMic(); micBtn.classList.toggle('btn-danger', !audioTrack.enabled); } };
      updateMic();
      micBtn.classList.toggle('btn-danger', !(audioTrack && audioTrack.enabled));

      // Mic-driven animation (RMS ‚Üí scale for listening state)
      try {
        const audioTracks = stream.getAudioTracks();
        if (audioTracks && audioTracks.length) {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const src = ctx.createMediaStreamSource(stream);
          const analyser = ctx.createAnalyser();
          analyser.fftSize = 2048;
          const data = new Float32Array(analyser.fftSize);
          src.connect(analyser);
          let rafId;
          let smooth = 1.0;
          const render = () => {
            analyser.getFloatTimeDomainData(data);
            // RMS
            let sum = 0;
            for (let i = 0; i < data.length; i++) { const v = data[i]; sum += v*v; }
            const rms = Math.sqrt(sum / data.length);
            const el = document.getElementById('botIndicator');
            if (el) {
              if (el.classList.contains('listening')) {
                // Map RMS (~0..0.3) ‚Üí target scale 1.00..1.06 (clamped)
                const amp = Math.min(0.06, rms * 0.4); // 0..~0.12 ‚Üí clamp 0.06
                const target = 1.0 + amp;
                // Smooth step (low-pass filter)
                smooth = smooth * 0.85 + target * 0.15;
                el.style.setProperty('--levelScale', smooth.toFixed(3));
              } else {
                smooth = 1.0;
                el.style.setProperty('--levelScale', '1.000');
              }
            }
            rafId = requestAnimationFrame(render);
          };
          render();
          // cleanup on leave
          document.getElementById('leaveBtn').addEventListener('click', () => {
            try { cancelAnimationFrame(rafId); ctx.close(); } catch(_) {}
          }, { once: true });
        }
      } catch(e) { /* ignore */ }

      // video toggle (show placeholder when off)
      const videoBtn = document.getElementById('videoToggle');
      const videoTrack = stream.getVideoTracks()[0] || null;
      videoBtn.disabled = !videoTrack;
      function updateVideo() {
        if (!videoTrack) return;
        videoBtn.textContent = '–ö–∞–º–µ—Ä–∞: ' + (videoTrack.enabled ? '–≤–∫–ª' : '–≤—ã–∫–ª');
        if (videoTrack.enabled) { localVideo.style.display = ''; placeholder.style.display = 'none'; }
        else { localVideo.style.display = 'none'; placeholder.style.display = ''; }
      }
      videoBtn.onclick = () => { if (videoTrack) { videoTrack.enabled = !videoTrack.enabled; updateVideo(); videoBtn.classList.toggle('btn-danger', !videoTrack.enabled); } };
      updateVideo();
      videoBtn.classList.toggle('btn-danger', !(videoTrack && videoTrack.enabled));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const resp = await fetch(`/webrtc/offer/${cid}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type })
      });
      const data = await resp.json();
      if (!pc.currentRemoteDescription) {
        await pc.setRemoteDescription(new RTCSessionDescription(data));
      }
      joining = false;

      document.getElementById('joinBtn').disabled = true;
      document.getElementById('leaveBtn').disabled = false;
      document.getElementById('micToggle').disabled = false;
      if (videoTrack) document.getElementById('videoToggle').disabled = false;
      status('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
    } catch (e) {
      try { if (pc) { pc.getSenders().forEach(s => s.track && s.track.stop()); pc.close(); } } catch(_) {}
      pc = null;
      try { if (ws) { ws.close(); } } catch(_) {}
      ws = null;
      joining = false;
      document.getElementById('joinBtn').disabled = false;
      status('–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e));
    }
  }

  function leave() {
    try {
      const cid = document.getElementById('cid').value;
      // notify server to finish interview
      fetch(`/call/finish/${cid}`, { method: 'POST' }).catch(()=>{});
      if (pc) {
        pc.getSenders().forEach(s => s.track && s.track.stop());
        pc.close();
        pc = null;
      }
      try { if (ws) { ws.close(); } } catch(_) {}
      ws = null;
    } finally {
      document.getElementById('joinBtn').disabled = false;
      document.getElementById('leaveBtn').disabled = true;
      // disable toggles when not connected
      const micBtn = document.getElementById('micToggle');
      const videoBtn = document.getElementById('videoToggle');
      micBtn.disabled = true; micBtn.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª';
      if (videoBtn) { videoBtn.disabled = true; videoBtn.textContent = '–ö–∞–º–µ—Ä–∞: –≤—ã–∫–ª'; }
      status('–û—Ç–∫–ª—é—á–µ–Ω–æ');
    }
  }

  document.getElementById('joinBtn').onclick = join;
  document.getElementById('leaveBtn').onclick = leave;
</script>
{% endblock %}
