{% extends "base.html" %}
{% block content %}
<h1>–ö–∞–Ω–¥–∏–¥–∞—Ç #{{ c.id }}</h1>

<section class="card">
  <h3>–ü–∞—Å–ø–æ—Ä—Ç</h3>
    <ul class="kv">
      <li><b>–§–ò–û:</b> {{ c.full_name or "‚Äî" }}</li>
      <li><b>–í–æ–∑—Ä–∞—Å—Ç:</b> {{ c.age or "‚Äî" }}</li>
      <li><b>–ü–æ–ª:</b> {{ c.gender or "‚Äî" }}</li>
      <li><b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {{ c.phone or "‚Äî" }}</li>
      <li><b>–ê–¥—Ä–µ—Å:</b> {{ c.address or "‚Äî" }}</li>
      <li><b>–°—Ç–∞—Ç—É—Å:</b> <span class="badge status-{{ c.candidate_status }}">{{ status_label }}</span></li>
      <li><b>–§–∞–π–ª:</b> {{ c.resume_path }}</li>
      <li><b>–°–æ–∑–¥–∞–Ω:</b> {{ c.created_at }}</li>
    </ul>

  <div class="actions-row">
    <form method="post" action="/candidates/{{ c.id }}/status" class="inline">
      <select name="new_status">
        {% for code,label in STATUS_CHOICES %}
          <option value="{{ code }}" {% if code==c.candidate_status %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <button class="btn">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </form>

    <form method="post" action="/candidates/{{ c.id }}/delete" class="inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ #{{ c.id }} –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã? –û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞.');">
      <button class="btn-danger" id="deleteBtn">–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</button>
    </form>
  </div>
  {% if c.candidate_status == 'screen_passed' %}
    <div class="actions-row-secondary">
      <button class="btn-outline" id="copyCallBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ</button>
    </div>
  {% endif %}
</section>

<script>
  (function(){
    const btn = document.getElementById('copyCallBtn');
    const delBtn = document.getElementById('deleteBtn');
    if (btn) {
      btn.addEventListener('click', async () => {
        const url = '{{ call_base_url }}/call/{{ c.id }}';
        try {
          await navigator.clipboard.writeText(url);
          btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
          setTimeout(() => btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ', 1200);
        } catch (e) {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = url; document.body.appendChild(ta); ta.select();
          document.execCommand('copy'); document.body.removeChild(ta);
        }
      });
    }
    if (delBtn) {
      delBtn.addEventListener('click', () => {
        delBtn.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ‚Ä¶';
        delBtn.classList.add('disabled');
        setTimeout(() => { /* visual feedback only */ }, 50);
      });
    }
  })();
  </script>

<section class="card">
  <h3>–û—Ç—á–µ—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞</h3>
  {% if analyses %}
    <ul>
      {% for a in analyses %}
        <li>
          <div><b>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª:</b> {{ a.avg_score }} | <b>–í–µ—Ä–¥–∏–∫—Ç:</b> {{ a.verdict }}</div>
          <div><b>–í—ã–≤–æ–¥:</b> {{ a.summary }}</div>
          <div class="muted">{{ a.created_at }}</div>

          <h4>–†–µ–∑—é–º–µ —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏</h4>
          <div class="resume-box">{{ a.resume_html | safe }}</div>

          {% set report = a.report %}
          {% if report %}
            {% set anal = report.get("–ê–Ω–∞–ª–∏–∑") or {} %}
            {% set grades = anal.get("–û—Ü–µ–Ω–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π") or {} %}
            {% if grades %}
              <h4>–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ</th>
                    <th style="width:120px">–ë–∞–ª–ª—ã</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                  </tr>
                </thead>
                <tbody>
                  {% for req, g in grades.items() %}
                    {% set score = (g.get("–±–∞–ª–ª") or 0) | int %}
                    <tr>
                      <td>{{ req }}</td>
                      <td>{{ score }}%</td>
                      <td>{{ g.get('–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π') or '' }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          {% endif %}
          {% if report and report.get("–í–æ–ø—Ä–æ—Å—ã") %}
            <h4>–í–æ–ø—Ä–æ—Å—ã –∫–∞–Ω–¥–∏–¥–∞—Ç—É</h4>
            <ul>
              {% for q in report.get("–í–æ–ø—Ä–æ—Å—ã") %}
                <li>{{ q }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –∞–Ω–∞–ª–∏–∑–∞.</p>
  {% endif %}
</section>

{% if last_interview %}
<section class="card">
  <h3>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–Ω—Ç–µ—Ä–≤—å—é</h3>
  <div class="muted">–î–∞—Ç–∞: {{ last_interview.created_at }}</div>
  {% if last_interview.log %}
    <div class="resume-box" style="max-height:300px;">
      {% for m in last_interview.log %}
        <div><b>{{ 'ü§ñ' if m.role=='assistant' else ('üë§' if m.role=='user' else '‚ÑπÔ∏è') }}</b> {{ m.text }}</div>
      {% endfor %}
    </div>
  {% else %}
    <div class="muted">–õ–∏—Å—Ç–∏–Ω–≥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
  {% endif %}
  {% if last_interview.report %}
    <details class="report" style="margin-top:8px"><summary>–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç (JSON)</summary>
      <pre class="resume-raw">{{ last_interview.report | tojson(indent=2) }}</pre>
    </details>
  {% endif %}
</section>
{% endif %}
{% endblock %}
