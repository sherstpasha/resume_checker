{% extends "base.html" %}
{% block content %}
<h1>Кандидат #{{ c.id }}</h1>

<section class="card">
  <h3>Паспорт</h3>
    <ul class="kv">
      <li><b>ФИО:</b> {{ c.full_name or "—" }}</li>
      <li><b>Возраст:</b> {{ c.age or "—" }}</li>
      <li><b>Пол:</b> {{ c.gender or "—" }}</li>
      <li><b>Телефон:</b> {{ c.phone or "—" }}</li>
      <li><b>Адрес:</b> {{ c.address or "—" }}</li>
      <li><b>Статус:</b> <span class="badge status-{{ c.candidate_status }}">{{ status_label }}</span></li>
      <li><b>Файл:</b> {{ c.resume_path }}</li>
      <li><b>Создан:</b> {{ c.created_at }}</li>
    </ul>

  <div class="actions-row">
    <form method="post" action="/candidates/{{ c.id }}/status" class="inline">
      <select name="new_status">
        {% for code,label in STATUS_CHOICES %}
          <option value="{{ code }}" {% if code==c.candidate_status %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <button class="btn">Обновить статус</button>
    </form>

    <form method="post" action="/candidates/{{ c.id }}/delete" class="inline" onsubmit="return confirm('Удалить кандидата #{{ c.id }} и все связанные анализы? Операция необратима.');">
      <button class="btn-danger" id="deleteBtn">Удалить кандидата</button>
    </form>
  </div>
  {% if c.candidate_status == 'screen_passed' %}
    <div class="actions-row-secondary">
      <button class="btn-outline" id="copyCallBtn">Скопировать ссылку на собеседование</button>
    </div>
  {% endif %}
</section>

<script>
  (function(){
    const btn = document.getElementById('copyCallBtn');
    const delBtn = document.getElementById('deleteBtn');
    if (btn) {
      btn.addEventListener('click', async () => {
        const url = '{{ call_base_url }}/call/{{ c.id }}';
        try {
          await navigator.clipboard.writeText(url);
          btn.textContent = 'Скопировано';
          setTimeout(() => btn.textContent = 'Скопировать ссылку на собеседование', 1200);
        } catch (e) {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = url; document.body.appendChild(ta); ta.select();
          document.execCommand('copy'); document.body.removeChild(ta);
        }
      });
    }
    if (delBtn) {
      delBtn.addEventListener('click', () => {
        delBtn.textContent = 'Удаление…';
        delBtn.classList.add('disabled');
        setTimeout(() => { /* visual feedback only */ }, 50);
      });
    }
  })();
  </script>

<section class="card">
  <h3>Отчет скрининга</h3>
  {% if analyses %}
    <ul>
      {% for a in analyses %}
        <li>
          <div><b>Средний балл:</b> {{ a.avg_score }} | <b>Вердикт:</b> {{ a.verdict }}</div>
          <div><b>Вывод:</b> {{ a.summary }}</div>
          <div class="muted">{{ a.created_at }}</div>

          <h4>Резюме с аннотациями</h4>
          <div class="resume-box">{{ a.resume_html | safe }}</div>

          {% set report = a.report %}
          {% if report %}
            {% set anal = report.get("Анализ") or {} %}
            {% set grades = anal.get("Оценка требований") or {} %}
            {% if grades %}
              <h4>Соответствие требованиям</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>Требование</th>
                    <th style="width:120px">Баллы</th>
                    <th>Комментарий</th>
                  </tr>
                </thead>
                <tbody>
                  {% for req, g in grades.items() %}
                    {% set score = (g.get("балл") or 0) | int %}
                    <tr>
                      <td>{{ req }}</td>
                      <td>{{ score }}%</td>
                      <td>{{ g.get('комментарий') or '' }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          {% endif %}
          {% if report and report.get("Вопросы") %}
            <h4>Вопросы кандидату</h4>
            <ul>
              {% for q in report.get("Вопросы") %}
                <li>{{ q }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Пока нет записей анализа.</p>
  {% endif %}
</section>
{% endblock %}
